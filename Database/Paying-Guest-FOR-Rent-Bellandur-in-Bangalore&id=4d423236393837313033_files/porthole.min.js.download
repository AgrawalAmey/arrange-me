(function(){var B=false,A=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.PortholeClass=function(){};PortholeClass.extend=function(C){var D=this.prototype;B=true;var E=new this();B=false;for(var F in C){E[F]=typeof C[F]=="function"&&typeof D[F]=="function"&&A.test(C[F])?(function(I,H){return function(){var J=this._super;this._super=D[I];var K=H.apply(this,arguments);this._super=J;return K}})(F,C[F]):C[F]}function G(){if(!B&&this.init){this.init.apply(this,arguments)}}G.prototype=E;G.prototype.constructor=G;G.extend=arguments.callee;return G}})();(function(C){var A={debug:false,trace:function(D){if(this.debug&&C.console!==undefined){C.console.log("Porthole: "+D)}},error:function(D){if(C.console!==undefined){C.console.error("Porthole: "+D)}}};A.WindowProxy=function(){};A.WindowProxy.prototype={post:function(D,E){},addEventListener:function(D){},removeEventListener:function(D){}};A.WindowProxyBase=PortholeClass.extend({init:function(D){if(D===undefined){D=""}this.targetWindowName=D;this.origin=C.location.protocol+"//"+C.location.host;this.eventListeners=[]},getTargetWindowName:function(){return this.targetWindowName},getOrigin:function(){return this.origin},getTargetWindow:function(){return A.WindowProxy.getTargetWindow(this.targetWindowName)},post:function(D,E){if(E===undefined){E="*"}this.dispatchMessage({data:D,sourceOrigin:this.getOrigin(),targetOrigin:E,sourceWindowName:C.name,targetWindowName:this.getTargetWindowName()})},addEventListener:function(D){this.eventListeners.push(D);return D},removeEventListener:function(E){var F;try{F=this.eventListeners.indexOf(E);this.eventListeners.splice(F,1)}catch(D){this.eventListeners=[]}},dispatchEvent:function(E){var F;for(F=0;F<this.eventListeners.length;F++){try{this.eventListeners[F](E)}catch(D){}}}});A.WindowProxyLegacy=A.WindowProxyBase.extend({init:function(E,D){this._super(D);if(E!==null){this.proxyIFrameName=this.targetWindowName+"ProxyIFrame";this.proxyIFrameLocation=E;this.proxyIFrameElement=this.createIFrameProxy()}else{this.proxyIFrameElement=null;A.trace("proxyIFrameUrl is null, window will be a receiver only");this.post=function(){throw new Error("Receiver only window")}}},createIFrameProxy:function(){var D=document.createElement("iframe");D.setAttribute("id",this.proxyIFrameName);D.setAttribute("name",this.proxyIFrameName);D.setAttribute("src",this.proxyIFrameLocation);D.setAttribute("frameBorder","1");D.setAttribute("scrolling","auto");D.setAttribute("width",30);D.setAttribute("height",30);D.setAttribute("style","position: absolute; left: -100px; top:0px;");if(D.style.setAttribute){D.style.setAttribute("cssText","position: absolute; left: -100px; top:0px;")}document.body.appendChild(D);return D},dispatchMessage:function(E){var F=C.encodeURIComponent;if(this.proxyIFrameElement){var D=this.proxyIFrameLocation+"#"+F(A.WindowProxy.serialize(E));this.proxyIFrameElement.setAttribute("src",D);this.proxyIFrameElement.height=this.proxyIFrameElement.height>50?50:100}}});A.WindowProxyHTML5=A.WindowProxyBase.extend({init:function(E,D){this._super(D);this.eventListenerCallback=null},dispatchMessage:function(D){this.getTargetWindow().postMessage(A.WindowProxy.serialize(D),D.targetOrigin)},addEventListener:function(D){if(this.eventListeners.length===0){var E=this;if(C.addEventListener){this.eventListenerCallback=function(F){E.eventListener(E,F)};C.addEventListener("message",this.eventListenerCallback,false)}else{if(C.attachEvent){this.eventListenerCallback=function(F){E.eventListener(E,C.event)};C.attachEvent("onmessage",this.eventListenerCallback)}}}return this._super(D)},removeEventListener:function(D){this._super(D);if(this.eventListeners.length===0){if(C.removeEventListener){C.removeEventListener("message",this.eventListenerCallback)}else{if(C.detachEvent){if(typeof C.onmessage==="undefined"){C.onmessage=null}C.detachEvent("onmessage",this.eventListenerCallback)}}this.eventListenerCallback=null}},eventListener:function(E,F){var D=A.WindowProxy.unserialize(F.data);if(D&&(E.targetWindowName===""||D.sourceWindowName==E.targetWindowName)){E.dispatchEvent(new A.MessageEvent(D.data,F.origin,E))}}});if(!C.postMessage){A.trace("Using legacy browser support");A.WindowProxy=A.WindowProxyLegacy.extend({})}else{A.trace("Using built-in browser support");A.WindowProxy=A.WindowProxyHTML5.extend({})}A.WindowProxy.serialize=function(D){if(typeof JSON==="undefined"){throw new Error("Porthole serialization depends on JSON!")}return JSON.stringify(D)};A.WindowProxy.unserialize=function(D){if(typeof JSON==="undefined"){throw new Error("Porthole unserialization dependens on JSON!")}try{var F=JSON.parse(D)}catch(E){return false}return F};A.WindowProxy.getTargetWindow=function(D){if(D===""){return parent}else{if(D==="top"||D==="parent"){return C[D]}}return C.frames[D]};A.MessageEvent=function B(D,F,E){this.data=D;this.origin=F;this.source=E};A.WindowProxyDispatcher={forwardMessageEvent:function(D){var F,E=C.decodeURIComponent,G,H;if(document.location.hash.length>0){F=A.WindowProxy.unserialize(E(document.location.hash.substr(1)));G=A.WindowProxy.getTargetWindow(F.targetWindowName);H=A.WindowProxyDispatcher.findWindowProxyObjectInWindow(G,F.sourceWindowName);if(H){if(H.origin===F.targetOrigin||F.targetOrigin==="*"){H.dispatchEvent(new A.MessageEvent(F.data,F.sourceOrigin,H))}else{A.error("Target origin "+H.origin+" does not match desired target of "+F.targetOrigin)}}else{A.error("Could not find window proxy object on the target window")}}},findWindowProxyObjectInWindow:function(G,E){var F;if(G){for(F in G){if(Object.prototype.hasOwnProperty.call(G,F)){try{if(G[F]!==null&&typeof G[F]==="object"&&G[F] instanceof G.Porthole.WindowProxy&&G[F].getTargetWindowName()===E){return G[F]}}catch(D){}}}}return null},start:function(){if(C.addEventListener){C.addEventListener("resize",A.WindowProxyDispatcher.forwardMessageEvent,false)}else{if(C.attachEvent&&C.postMessage!=="undefined"){C.attachEvent("onresize",A.WindowProxyDispatcher.forwardMessageEvent)}else{if(document.body.attachEvent){C.attachEvent("onresize",A.WindowProxyDispatcher.forwardMessageEvent)}else{A.error("Cannot attach resize event")}}}}};if(typeof C.exports!=="undefined"){C.exports.Porthole=A}else{C.Porthole=A}})(this);